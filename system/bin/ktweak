UINT_MAX="4294967295"

SCHED_PERIOD="$((1 * 1000 * 1000))"

SCHED_TASKS="10"

write() {
	[[ ! -f "$1" ]] && return 1

	chmod +w "$1" 2> /dev/null

	if ! echo "$2" > "$1" 2> /dev/null
	then
		echo "Failed: $1 → $2"
		return 1
	fi

	echo "$1 → $2"
}

if [[ "$(id -u)" -ne 0 ]]
then
	echo "No root permissions. Exiting."
	exit 1
fi

grep -q android /proc/cmdline && ANDROID=true

sync

write /proc/sys/kernel/perf_cpu_time_max_percent 3

write /proc/sys/kernel/sched_autogroup_enabled 1

write /proc/sys/kernel/sched_child_runs_first 1

write /proc/sys/kernel/sched_tunable_scaling 0

write /proc/sys/kernel/sched_latency_ns "$SCHED_PERIOD"

write /proc/sys/kernel/sched_min_granularity_ns "$((SCHED_PERIOD / SCHED_TASKS))"

write /proc/sys/kernel/sched_wakeup_granularity_ns "$((SCHED_PERIOD / 2))"

write /proc/sys/kernel/sched_migration_cost_ns 5000000

[[ "$ANDROID" == true ]] && write /proc/sys/kernel/sched_min_task_util_for_colocation 0

write /proc/sys/kernel/sched_nr_migrate 4

write /proc/sys/kernel/sched_schedstats 0

write /proc/sys/kernel/printk_devkmsg off

write /proc/sys/vm/dirty_background_ratio 3

write /proc/sys/vm/dirty_ratio 30

write /proc/sys/vm/dirty_expire_centisecs 3000

write /proc/sys/vm/dirty_writeback_centisecs 3000

write /proc/sys/vm/page-cluster 0

write /proc/sys/vm/stat_interval 10

write /proc/sys/vm/swappiness 100

write /proc/sys/vm/vfs_cache_pressure 200

write /proc/sys/net/ipv4/tcp_ecn 1

write /proc/sys/net/ipv4/tcp_fastopen 3

write /proc/sys/net/ipv4/tcp_syncookies 0

if [[ -f "/sys/kernel/debug/sched_features" ]]
then
	write /sys/kernel/debug/sched_features NEXT_BUDDY

	write /sys/kernel/debug/sched_features NO_TTWU_QUEUE
fi

[[ "$ANDROID" == true ]] && if [[ -d "/dev/stune/" ]]
then
	write /dev/stune/top-app/schedtune.prefer_idle 1

	write /dev/stune/top-app/schedtune.boost 1
fi

for cpu in /sys/devices/system/cpu/cpu*/cpufreq
do
	avail_govs="$(cat "$cpu/scaling_available_governors")"

	for governor in schedutil interactive
	do
		if [[ "$avail_govs" == *"$governor"* ]]
		then
			write "$cpu/scaling_governor" "$governor"
			break
		fi
	done
done

find /sys/devices/system/cpu/ -name schedutil -type d | while IFS= read -r governor
do
	write "$governor/up_rate_limit_us" 0
	write "$governor/down_rate_limit_us" 0
	write "$governor/rate_limit_us" 0
	write "$governor/hispeed_load" 85
	write "$governor/hispeed_freq" "$UINT_MAX"
done

for queue in /sys/block/*/queue
do
	write "$queue/add_random" 0

	write "$queue/iostats" 0

	write "$queue/read_ahead_kb" 32

	write "$queue/nr_requests" 32
done

exit 0
